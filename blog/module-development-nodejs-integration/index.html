<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN"
  "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" version="XHTML+RDFa 1.0" dir="ltr"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:dc="http://purl.org/dc/terms/"
  xmlns:foaf="http://xmlns.com/foaf/0.1/"
  xmlns:og="http://ogp.me/ns#"
  xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
  xmlns:sioc="http://rdfs.org/sioc/ns#"
  xmlns:sioct="http://rdfs.org/sioc/types#"
  xmlns:skos="http://www.w3.org/2004/02/skos/core#"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema#">


<!-- Mirrored from theoleschool.com/blog/module-development-nodejs-integration by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 26 Sep 2015 17:07:09 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="I&#039;ve been spending some time experimenting with NodeJS in relation to the Drupal environment.  In many of these Node/Drupal interactions the NodeJS Integration module has become a key player.  There is a very helpful pdf from a talk that beejeebus gave at Drupal camp New Jersey that gives few great visualizations of the underlying principles of how this module works.  In essence it &quot;takes care of the plumbing,&quot;  leaving you, the developer, free to focus on how you would like to integrate. The module is easy to use, and provides a nice set of functions to quickly get rolling.  To that point I would like to give a very simple example demonstrating the use of the nodejs integration module." />
<link rel="shortcut icon" href="../../misc/favicon/index.ico" type="image/vnd.microsoft.icon" />
<meta content="Module Development with NodeJS Integration" about="/blog/module-development-nodejs-integration" property="dc:title" />
<meta name="keywords" content="drupal, web development, nodejs" />
<link rel="canonical" href="index.html" />
<link rel="shortlink" href="index.html" />
<meta name="generator" content="Drupal 7 (http://drupal.org)" />
  <title>Module Development with NodeJS Integration | theoleschool</title>
  <link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_pbm0lsQQJ7A7WCCIMgxLho6mI_kBNgznNUWmTWcnfoE/index.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_botNHIYRQPys-RH2iA3U4LbV9bPNRS64tLAs8ec1ch8/index.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_ggwmJjnSHIyQGr6BcS46i7z-SeJR7vFJ2H8b7fsUJ1o/index.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_wTnXwKLp1ec_eSA6aRSbc1Cr7mXlDTPbLelDm9ZTjQg/index.css" media="screen" />
  <script type="text/javascript" src="../../sites/default/files/js/js_xAPl0qIk9eowy_iS9tNkCWXLUVoat94SQT48UBCFkyQ/index.js"></script>
<script type="text/javascript" src="../../sites/default/files/js/js_mEEqrZApHAidJyywsmZR_Ac1d4B-4FLzvR9sbsjVDyg/index.js"></script>
<script type="text/javascript" src="../../sites/default/files/js/js_IDBX5SzkJ9gGNq7x-qOE_2DZsexqguTJQGMKvi4w-Uw/index.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-25692833-1"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = "../../sites/default/files/googleanalytics/ga/index.js?nvammp";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
<script type="text/javascript" src="../../sites/default/files/js/js_ix99IaKNwg4XQrjVLFsrlxH0Czfb_Wvr8_P-vBK2zQU/index.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"olesain","theme_token":"EiymVn7LWNFdnuDTC6cnZn861lutKeEW3_JCqOkArPU","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/admin_menu\/admin_devel\/admin_devel.js":1,"sites\/all\/modules\/google_analytics\/googleanalytics.js":1,"0":1,"sites\/all\/modules\/disqus\/disqus.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"sites\/all\/modules\/geshifilter\/geshifilter.css":1,"sites\/default\/themes\/olesain\/css\/reset.css":1,"sites\/default\/themes\/olesain\/css\/style.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip"},"disqus":{"domain":"Theoleschool","url":"http:\/\/theoleschool.com\/blog\/module-development-nodejs-integration","title":"Module Development with NodeJS Integration","identifier":"node\/160"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-160 node-type-article" >
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="center-col">
  <!--  Main Content Container -->
  <div id="main-wrap">
    <div class="content-wrap">
              <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div id="node-160" class="node node-article node-promoted clearfix">
      <div class="meta clearfix">
      <div class="auth">April 21, 2012</div>
      <div class="created">10:49am</div>
    </div>
  
    <h2 class="node-title">Module Development with NodeJS Integration</h2>    <div class="tags clearfix"><div class="field field-name-field-blog-tags field-type-taxonomy-term-reference field-label-hidden"><div class="field-items"><div class="field-item even"><a href="../../tags/nodejs/" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">nodejs</a></div><div class="field-item odd"><a href="../../tags/7x/" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">7.x</a></div><div class="field-item even"><a href="../../tags/drupal/" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">drupal</a></div></div></div></div>

        <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>I've been spending some time experimenting with <a href="http://nodejs.org/">NodeJS</a> in relation to the Drupal environment.  In many of these Node/Drupal interactions the <a href="http://drupal.org/project/nodejs">NodeJS Integration module</a> has become a key player.  There is a very helpful pdf from <a href="http://www.drupalcampnj.org/sessions/drupal-and-nodejs">a talk that beejeebus gave at Drupal camp New Jersey</a> that gives few great visualizations of the underlying principles of how this module works.  In essence it "takes care of the plumbing,"  leaving you, the developer, free to focus on how you would like to integrate. The module is easy to use, and provides a nice set of functions to quickly get rolling.  To that point I would like to give a very simple example demonstrating the use of the nodejs integration module.</p>
<p>It's perhaps easiest to think of this integration as allowing Drupal to send messages (data) to a client via NodeJS "plumbing." I feel that the simplest and most transparent example is to allow the user to control what that message is and when it is sent.  In this demonstration we build a simple form.  This form allows a user to enter a message into a text field. Then on submit, it sends that message to all connected sockets and replaces a bit of <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #339933;">&lt;</span>h3<span style="color: #339933;">&gt;</span></code></span> markup within the form. This is very similar to the "broadcast notifications" form included with the NodeJS integration module, but much simpler.</p>
<p>To help visualize this I've setup an install to show <a href="http://demo.theoleschool.com/swap">this demo in action</a>.  If no one else is viewing the demo page while you are, which very likely will be the case, then I encourage you to open another session (open the page in another browser) and arrange the browser windows so you can see them both at once.  This way, when you submit in one session, you can see the text in the header change on the other. I've also checked in <a href="https://github.com/rh0/swapit_demo">the code on github</a> to help fill in the gaps from the snippets I provide here, and hopefully help to make sense of my yammering. So with that, lets get into a bit more detail...</p>
<h3 id="considerations">Begin with a few considerations.</h3>
<p>When you set out to create your module using NodeJS integration it may help to ask yourself some simple questions.</p>
<ul><li>Who receives the message?</li>
<li>What is the message?</li>
<li>How is the message triggered?</li>
<li>What will be done with the message once it is received?</li>
</ul><h3 id="who-receives">Who receives the message?</h3>
<p>After a user has requested a connection to socket.io, NodeJS sends this authentication token to Drupal. Drupal then sends back a list of channels the user can "listen" on.  To manage which channels a user is assigned to we can use <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #000000; font-weight: bold;">function</span> hook_nodejs_user_channels<span style="color: #009900;">(</span><span style="color: #000088;">$auth_user</span><span style="color: #009900;">)</span></code></span>. The <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #000088;">$auth_user</span></code></span> parameter is the user that is being authenticated. Any checks you might need to perform on the user to determine if they should be assigned a channel can be done here.</p><p>
</p><p>In our example we're keeping this really simple.  We want to send the message to all users so we give everyone who authenticates the 'swapit_demo' channel.</p>
<div class="geshifilter"><div class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">function</span> swapit_demo_nodejs_user_channels<span style="color: #009900;">(</span><span style="color: #000088;">$auth_user</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />
  <span style="color: #000088;">$channels</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">(</span><span style="color: #0000ff;">'swapit_demo'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><br />
  <span style="color: #b1b100;">return</span> <span style="color: #000088;">$channels</span><span style="color: #339933;">;</span><br /><span style="color: #009900;">}</span></div></div>
<h3 id="what-sends">What is the message and how is it triggered?</h3>
<p>The message itself is a small object that contains the data it is intended to send, along with some information on how/where to send it. The trigger could really be anything and will likely be pretty obvious based on your use case.  In our example module, we're providing the users a form to allow them to write the message that will then be sent on submit.  So all of the magic happens in our submit function.</p>
<div class="geshifilter"><div class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">function</span> swapit_demo_swap_submit<span style="color: #009900;">(</span><span style="color: #000088;">$form</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span><span style="color: #000088;">$form_state</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />
  <span style="color: #000088;">$user_msg</span> <span style="color: #339933;">=</span> check_plain<span style="color: #009900;">(</span><span style="color: #000088;">$form_state</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'values'</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'user_message'</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><br />
  <span style="color: #666666; font-style: italic;">//just doing a quick variable set to store the string.</span><br />
  variable_set<span style="color: #009900;">(</span><span style="color: #0000ff;">'demo_message'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$user_msg</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><br />
  <span style="color: #666666; font-style: italic;">//broadcasting the string to our listening javascript in waiting</span><br />
  <span style="color: #000088;">$message</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> stdClass<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><br />
  <span style="color: #000088;">$message</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">channel</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'swapit_demo'</span><span style="color: #339933;">;</span><br />
  <span style="color: #000088;">$message</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">broadcast</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #339933;">;</span><br />
  <span style="color: #000088;">$message</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">data</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'body'</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$user_msg</span><span style="color: #339933;">;</span><br />
  <span style="color: #000088;">$message</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">callback</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'swapIt'</span><span style="color: #339933;">;</span><br />
  nodejs_send_message<span style="color: #009900;">(</span><span style="color: #000088;">$message</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><br /><span style="color: #009900;">}</span></div></div>
<p>Here we are grabbing the form data from our textfield, and inserting it into a message object.  <em>Note how we are setting the channel to the one we set back in <span class="geshifilter"><code class="php geshifilter-php">hook_nodejs_user_channels</code></span>.</em>  Passing this object to <span class="geshifilter"><code class="php geshifilter-php">node_send_message</code></span> will get NodeJS to broadcast to all connected sockets having the 'swapit_demo' channel.  The <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #000088;">$message</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">data</span></code></span> array contains our user submitted message.  The <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #0000ff;">'body'</span></code></span> key is arbitrary.</p><p>
</p><h3 id="what-will-be-done">What will be done with the message?</h3>
<p>Now that we have a message being broadcast we need to have a bit of javascript on the client side that will receive and do something with it.  In our case, we simply want to replace the text in our given HTML element.</p>
<div class="geshifilter"><div class="jquery geshifilter-jquery" style="font-family:monospace;">Drupal.<span style="color: #660066;">Nodejs</span>.<span style="color: #660066;">callbacks</span>.<span style="color: #660066;">swapIt</span> <span style="color: #339933;">=</span> <span style="color: #009900;">{</span><br />
  <span style="color: #006600; font-style: italic;">//grab the message and inject into the header</span><br />
  callback<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</span> <span style="color: #009900;">(</span>message<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />
    <span style="color: #000066; font-weight: bold;">if</span><span style="color: #009900;">(</span>message.<span style="color: #660066;">channel</span> <span style="color: #339933;">==</span> <span style="color: #3366CC;">'swapit_demo'</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />
      <span style="color: #000066;">$</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'form #nodejs-selector'</span><span style="color: #009900;">)</span>.<a href="http://docs.jquery.com/Attributes/html"><span style="color: #000066;">html</span></a><span style="color: #009900;">(</span>message.<a href="http://docs.jquery.com/Core/data"><span style="color: #000066;">data</span></a>.<span style="color: #660066;">body</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span><br />
    <span style="color: #009900;">}</span><br />
  <span style="color: #009900;">}</span><br /><span style="color: #009900;">}</span><span style="color: #339933;">;</span></div></div>
<p>We first define a callback function to receive the message.  Note how the callback name is passed to the message object in the submit function in the previous snippet.  Our function now verifies the channel on the message object, and uses the message data to replace the text in the <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #666666; font-style: italic;">#nodejs-selector</span></code></span> element. Notice how <span class="geshifilter"><code class="php geshifilter-php"><span style="color: #000088;">$message</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">data</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'body'</span><span style="color: #009900;">]</span></code></span> has translated to <span class="geshifilter"><code class="jquery geshifilter-jquery">message.<a href="http://docs.jquery.com/Core/data"><span style="color: #000066;">data</span></a>.<span style="color: #660066;">body</span></code></span> in the javascript.  All that remains is to tell the nodejs integration module about the file containing our client side javascript.</p>
<div class="geshifilter"><div class="php geshifilter-php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">function</span> swapit_demo_nodejs_handlers_info<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span><br />
  <span style="color: #b1b100;">return</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">(</span><br />
    drupal_get_path<span style="color: #009900;">(</span><span style="color: #0000ff;">'module'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'swapit_demo'</span><span style="color: #009900;">)</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'/swapit_demo.client.js'</span><span style="color: #339933;">,</span><br />
  <span style="color: #009900;">)</span><span style="color: #339933;">;</span><br /><span style="color: #009900;">}</span></div></div>
<p>That about sums it up in the simplest way I knew how.  I welcome any questions, and would love to hear of others experience with this useful module</p>
<h3>Resources:</h3>
<ul><li>NodeJS Integration module ( <a href="http://drupal.org/project/nodejs">http://drupal.org/project/nodejs</a> )</li>
<li>beejeebus' talk at Drupalcamp NJ ( <a href="http://www.drupalcampnj.org/sessions/drupal-and-nodejs">http://www.drupalcampnj.org/sessions/drupal-and-nodejs</a> )</li>
<li>Demonstration of this module ( <a href="http://demo.theoleschool.com/swap">http://demo.theoleschool.com/swap</a> )</li>
<li>This code on github ( <a href="https://github.com/rh0/swapit_demo">https://github.com/rh0/swapit_demo</a> )</li>
</ul></div></div></div><div id="disqus_thread"><noscript><p><a href="http://theoleschool.disqus.com/?url=http%3A%2F%2Ftheoleschool.com%2Fblog%2Fmodule-development-nodejs-integration">View the discussion thread.</a></p></noscript></div>
    <div class="meta clearfix">
      </div>
  <div class="olesain-comments clearfix">
          </div>
</div>  </div>
</div>
  </div>
    </div>
  </div>
</div>
<!-- Header -->
<div id="meta-header" class="clearfix">
  <div class="header-content">
    <h1 class="logo"><a href="../../index/">
      <span class="name">Ryan Oles</span>
      <span class="name site-name">the<span class="color-orng">oles</span>chool.com</span>
    </a></h1>
        <!-- Navigation -->
          <div id="main-menu" class="top-nav clearfix">
        <h2 class="element-invisible">Main menu</h2><ul id="main-menu-nav" class="links clearfix"><li class="menu-345 first"><a href="../../about/">About</a></li>
<li class="menu-275 last"><a href="../../index/" title="go back to front page">Home</a></li>
</ul>      </div>
      </div>
</div>  </body>

<!-- Mirrored from theoleschool.com/blog/module-development-nodejs-integration by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 26 Sep 2015 17:07:10 GMT -->
</html>
