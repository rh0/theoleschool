<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xml:base="http://theoleschool.com"  xmlns:dc="http://purl.org/dc/elements/1.1/">
<channel>
 <title>theoleschool - stockAPI</title>
 <link>http://theoleschool.com/tags/stockapi</link>
 <description></description>
 <language>en</language>
<item>
 <title>Quick Stock Quote on Page Refresh</title>
 <link>http://theoleschool.com/blog/quick-stock-quote-page-refresh-0</link>
 <description>&lt;div class=&quot;field field-name-body field-type-text-with-summary field-label-hidden&quot;&gt;&lt;div class=&quot;field-items&quot;&gt;&lt;div class=&quot;field-item even&quot; property=&quot;content:encoded&quot;&gt;&lt;p&gt;I thought I would throw a post up, demonstrating a &quot;quick and easy&quot; use case of the &lt;a href=&quot;http://drupal.org/project/stockapi&quot;&gt;Stock API module&lt;/a&gt;, and simultaneously, give this site&#039;s &lt;a href=&quot;http://qbnz.com/highlighter/&quot;&gt;GeSHi filter&lt;/a&gt;  a quick test run.&lt;/p&gt;
&lt;p&gt;A few days ago I encountered a site requirement asking for a simple informative stock quote block on a Drupal 6.x installation.  The format required was something like:
&lt;br /&gt;&lt;em&gt;NFLX 208.75 -1.30 Sep 13 7:30 EST&lt;/em&gt; 
&lt;br /&gt;
My initial thought was to enable the &lt;a href=&quot;http://drupal.org/project/stock&quot;&gt;Stock module&lt;/a&gt; and simply configure and theme the built in block.  The stock module will allow the management of multiple stocks on a per-user basis, and provides a block that displays this information in a table.  There is no doubt that stock module is useful but in this instance it is overkill. All we are after is a simple quote from a single unchanging stock symbol displayed in a single line of text.&lt;/p&gt;
&lt;p&gt;So let&#039;s take a short step back to the stock API module. There is really one &quot;go to&quot; function when grabbing a quote from the stock api and that is &lt;span class=&quot;geshifilter&quot;&gt;&lt;code class=&quot;php geshifilter-php&quot;&gt;stockapi_load&lt;span style=&quot;color: #009900;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000088;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #009900;&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/span&gt;. This function is defined like so:&lt;/p&gt;
&lt;div class=&quot;geshifilter&quot;&gt;&lt;div class=&quot;drupal6 geshifilter-drupal6&quot; style=&quot;font-family:monospace;&quot;&gt;&lt;span style=&quot;color: #000000; font-weight: bold;&quot;&gt;function&lt;/span&gt; stockapi_load&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #b1b100;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;!&lt;/span&gt;&lt;a href=&quot;http://www.php.net/empty&quot;&gt;&lt;span style=&quot;color: #000066;&quot;&gt;empty&lt;/span&gt;&lt;/a&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt; = &lt;a href=&quot;http://api.drupal.org/api/function/db_fetch_array/6&quot;&gt;&lt;span style=&quot;color: #000066;&quot;&gt;db_fetch_array&lt;/span&gt;&lt;/a&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;a href=&quot;http://api.drupal.org/api/function/db_query/6&quot;&gt;&lt;span style=&quot;color: #000066;&quot;&gt;db_query&lt;/span&gt;&lt;/a&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;&quot;SELECT * FROM {stockapi} WHERE symbol = &#039;%s&#039;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;;&lt;br /&gt;
    &lt;span style=&quot;color: #b1b100;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;!&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
      &lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt; = stockapi_fetch&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;;&lt;br /&gt;
      &lt;span style=&quot;color: #b1b100;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
        &lt;span style=&quot;color: #b1b100;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #cc66cc;&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;]&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;!&lt;/span&gt;= &lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;N/A&#039;&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
          &lt;span style=&quot;color: #808080; font-style: italic;&quot;&gt;// Date is &#039;N/A&#039; means an invalid stock symbol&lt;/span&gt;&lt;br /&gt;
          stockapi_save&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;;&lt;br /&gt;&lt;br /&gt;
          &lt;span style=&quot;color: #808080; font-style: italic;&quot;&gt;// Load again so it can show for the first time&lt;/span&gt;&lt;br /&gt;
          &lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt; = stockapi_load&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;;&lt;br /&gt;
        &lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;br /&gt;
      &lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;br /&gt;
    &lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #b1b100;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;$stock&lt;/span&gt;;&lt;br /&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see the stock API module is wanting to store stock information in the database to be updated on cron runs.  It does this as a type of database caching.  This way if a site is pulling information on many stocks, potentially every page load, compounded by many users the API can retrieve the information with a simple query to the local database. Not only is this method much faster than hitting the third party service (yahoo) every time, it is able to serve saved information (especially handy if that service happens to be down or a connection cannot be established).  This feature along with returning a nice keyed array of stock information is reason enough to love this function. However, I think we could go a bit simpler still.  We only need information on one stock site wide, and in this instance that information should be as current as possible. Furthermore, I would like to avoid setting up a cron job to run every half hour just to keep stock information current. Rather, we look further into the Stock API and make a more basal call to &lt;span class=&quot;geshifilter&quot;&gt;&lt;code class=&quot;php geshifilter-php&quot;&gt;stockapi_fetch&lt;span style=&quot;color: #009900;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #000088;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #009900;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #339933;&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/span&gt;.  This function is a direct call to the 3rd party service, in this case yahoo:&lt;/p&gt;
&lt;div class=&quot;geshifilter&quot;&gt;&lt;div class=&quot;drupal6 geshifilter-drupal6&quot; style=&quot;font-family:monospace;&quot;&gt;&lt;span style=&quot;color: #808080; font-style: italic;&quot;&gt;/**&lt;br /&gt;
 * Fetch the stock info for a given ticker symbol from Yahoo!&lt;br /&gt;
 */&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: #000000; font-weight: bold;&quot;&gt;function&lt;/span&gt; stockapi_fetch&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #b1b100;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;a href=&quot;http://www.php.net/empty&quot;&gt;&lt;span style=&quot;color: #000066;&quot;&gt;empty&lt;/span&gt;&lt;/a&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
    &lt;span style=&quot;color: #b1b100;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #000000; font-weight: bold;&quot;&gt;FALSE&lt;/span&gt;;&lt;br /&gt;
  &lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #0000ff;&quot;&gt;$fields&lt;/span&gt; = &lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;snl1c1ohgvd1t1&#039;&lt;/span&gt;;&lt;br /&gt;
  &lt;span style=&quot;color: #808080; font-style: italic;&quot;&gt;/*&lt;br /&gt;
    &quot;s&quot;  =&amp;gt; &quot;Symbol&quot;,&lt;br /&gt;
    &quot;n&quot;  =&amp;gt; &quot;Name&quot;,&lt;br /&gt;
    &quot;l1&quot; =&amp;gt; &quot;Last&quot;,&lt;br /&gt;
    &quot;c1&quot; =&amp;gt; &quot;Change&quot;,&lt;br /&gt;
    &quot;o&quot;  =&amp;gt; &quot;Opening&quot;,&lt;br /&gt;
    &quot;h&quot;  =&amp;gt; &quot;High&quot;,&lt;br /&gt;
    &quot;g&quot;  =&amp;gt; &quot;Low&quot;,&lt;br /&gt;
    &quot;v&quot;  =&amp;gt; &quot;Volume&quot;,&lt;br /&gt;
    &quot;d1&quot; =&amp;gt; &quot;Date&quot;,&lt;br /&gt;
    &quot;t1&quot; =&amp;gt; &quot;Time&quot;&lt;br /&gt;
   */&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #0000ff;&quot;&gt;$host&lt;/span&gt; = &lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;http://download.finance.yahoo.com&#039;&lt;/span&gt;;&lt;br /&gt;
  &lt;span style=&quot;color: #0000ff;&quot;&gt;$url&lt;/span&gt; = &lt;span style=&quot;color: #0000ff;&quot;&gt;$host&lt;/span&gt; .&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;/d/quotes.csv?s=&#039;&lt;/span&gt;. &lt;a href=&quot;http://www.php.net/urlencode&quot;&gt;&lt;span style=&quot;color: #000066;&quot;&gt;urlencode&lt;/span&gt;&lt;/a&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$symbol&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; .&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;&amp;amp;f=&#039;&lt;/span&gt;.&lt;span style=&quot;color: #0000ff;&quot;&gt;$fields&lt;/span&gt;.&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;&amp;amp;e=.csv&#039;&lt;/span&gt;;&lt;br /&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #0000ff;&quot;&gt;$result&lt;/span&gt; = &lt;a href=&quot;http://api.drupal.org/api/function/drupal_http_request/6&quot;&gt;&lt;span style=&quot;color: #000066;&quot;&gt;drupal_http_request&lt;/span&gt;&lt;/a&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$url&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;;&lt;br /&gt;
  ...&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This ensures fresh data, without a cron run to update the database.  This function is not quite as nice as the &lt;span class=&quot;geshifilter&quot;&gt;&lt;code class=&quot;php geshifilter-php&quot;&gt;stockapi_load&lt;span style=&quot;color: #009900;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #009900;&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/span&gt; function in that the array it returns is not keyed.  The commented section above (from the module) comes to the rescue. It is in the same sequence as the array returned so it can be used as a reference. So to return something like our requirement example above:&lt;br /&gt;&lt;em&gt;NFLX 208.75 -1.30 Sep 13 7:30 EST&lt;/em&gt;&lt;br /&gt;
We would write something like:&lt;/p&gt;
&lt;div class=&quot;geshifilter&quot;&gt;&lt;div class=&quot;drupal6 geshifilter-drupal6&quot; style=&quot;font-family:monospace;&quot;&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$output&lt;/span&gt; = &lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;&#039;&lt;/span&gt;;&lt;br /&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt; = stockapi_fetch&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;NFLX&#039;&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt;;&lt;br /&gt;&lt;span style=&quot;color: #b1b100;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;)&lt;/span&gt; &lt;span style=&quot;color: #66cc66;&quot;&gt;{&lt;/span&gt;&lt;br /&gt;
  &lt;span style=&quot;color: #0000ff;&quot;&gt;$output&lt;/span&gt; .= &lt;span style=&quot;color: #ff0000;&quot;&gt;&#039;&amp;lt;span class=&quot;my-stock-quote&quot;&amp;gt;&#039;&lt;/span&gt;.&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #cc66cc;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;]&lt;/span&gt;.&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039; &#039;&lt;/span&gt;.&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #cc66cc;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;]&lt;/span&gt;.&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039; &#039;&lt;/span&gt;.&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #cc66cc;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;]&lt;/span&gt;.&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039; &#039;&lt;/span&gt;.&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #cc66cc;&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;]&lt;/span&gt;.&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039; &#039;&lt;/span&gt;.&lt;span style=&quot;color: #0000ff;&quot;&gt;$my_stock&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;[&lt;/span&gt;&lt;span style=&quot;color: #cc66cc;&quot;&gt;9&lt;/span&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;]&lt;/span&gt;.&lt;span style=&quot;color: #ff0000;&quot;&gt;&#039; EST&amp;lt;/span&amp;gt;&#039;&lt;/span&gt;;&lt;br /&gt;&lt;span style=&quot;color: #66cc66;&quot;&gt;}&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: #b1b100;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;$output&lt;/span&gt;;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I wound up throwing a variant of the snippet above into a block created in my module, allowing me to then jump to panels and throw the output wherever I wanted.&lt;/p&gt; 
&lt;p&gt;Now I know... the example is somewhat contrived. There is no &quot;secret&quot; here.  Everything outlined in this post would quickly be revealed by only a few minutes of looking through the Stock API module.  I wanted to demonstrate that by making a simple call to the Stock API I was able to save significant time in themeing, as well as gain flexibility in function.  The alternative would be wrangling the output of the Stock module&#039;s block, and making concessions for it&#039;s functional behavior.  It is easy to fall into the thinking that Drupal site building is just finding a module that is a closest fit and wrestling with what it gives us. Indeed sometimes that may be the case (Organic Groups comes to mind), but to follow that line of thinking blindly is most certainly a mistake.&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;</description>
 <pubDate>Fri, 16 Sep 2011 04:28:56 +0000</pubDate>
 <dc:creator>rho</dc:creator>
 <guid isPermaLink="false">154 at http://theoleschool.com</guid>
</item>
</channel>
</rss>
